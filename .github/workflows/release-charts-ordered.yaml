name: Release charts

on:
  push:
    branches: [ main ]
    paths:
      - 'charts/**'
  workflow_run:
    workflows: [ "Remotely-triggered chart bump" ]
    branches:   [ main ]
    types: [ completed ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  GH_PAGES_URL: https://bcit-ltc.github.io/helm-charts
  LIB_NAME: apps-common
  CHARTS_DIR: charts

jobs:
  release-all:
    name: Release library, apps
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Compute changed charts
        id: changes
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          BEFORE: ${{ github.event.before }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          if [[ "$GITHUB_EVENT_NAME" == "push" && -n "${BEFORE}" ]]; then
            BASE="${BEFORE}"
            HEAD="${SHA}"
          else
            BASE="HEAD~1"
            HEAD="HEAD"
          fi

          echo "Diffing $BASE..$HEAD"
          mapfile -t files < <(git diff --name-only "$BASE" "$HEAD" -- 'charts/**' || true)

          if (( ${#files[@]} == 0 )); then
            echo "No chart changes detected."
            echo "charts=" >>"$GITHUB_OUTPUT"
            echo "lib_changed=false" >>"$GITHUB_OUTPUT"
            exit 0
          fi

          declare -A seen=()
          charts=()
          for f in "${files[@]}"; do
            rel="${f#charts/}"
            chart="${rel%%/*}"
            [[ -n "$chart" ]] || continue
            [[ -n "${seen[$chart]:-}" ]] && continue
            seen[$chart]=1
            charts+=("$chart")
          done

          changed_csv="$(IFS=,; echo "${charts[*]}")"
          echo "Changed charts: $changed_csv"
          echo "charts=$changed_csv" >>"$GITHUB_OUTPUT"

          if printf '%s\n' "${charts[@]}" | grep -qx 'apps-common'; then
            echo "lib_changed=true" >>"$GITHUB_OUTPUT"
          else
            echo "lib_changed=false" >>"$GITHUB_OUTPUT"
          fi

      - uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Install chart-releaser CLI
        uses: helm/chart-releaser-action@v1.7.0
        with:
          install_only: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------
      # LIBRARY
      # ----------------------------
      - name: Package library (apps-common)
        if: steps.changes.outputs.lib_changed == 'true'
        run: |
          set -euo pipefail
          rm -rf .cr-release-packages
          mkdir -p .cr-release-packages
          cr package charts/apps-common --package-path .cr-release-packages

      - name: Upload library to Releases
        if: steps.changes.outputs.lib_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cr upload \
            --owner "${GITHUB_REPOSITORY_OWNER}" \
            --git-repo "${GITHUB_REPOSITORY#*/}" \
            --skip-existing \
            --token "${GH_TOKEN}"

      - name: Publish library to gh-pages (early)
        if: steps.changes.outputs.lib_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REPO_URL: https://bcit-ltc.github.io/helm-charts
        run: |
          set -euo pipefail
          rm -rf .gh-pages
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" .gh-pages || (
            git init .gh-pages
            pushd .gh-pages
            git checkout -b gh-pages
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
            git commit --allow-empty -m "init gh-pages"
            git push -u origin gh-pages
            popd
          )

          # publish only the library .tgz now so apps can fetch it
          cp -f .cr-release-packages/apps-common-*.tgz .gh-pages/ || true

          if [[ -f .gh-pages/index.yaml ]]; then
            helm repo index .gh-pages --url "${REPO_URL}" --merge .gh-pages/index.yaml
          else
            helm repo index .gh-pages --url "${REPO_URL}"
          fi

          pushd .gh-pages
          git add -A
          if ! git diff --cached --quiet; then
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "index: publish library for app deps"
            git push origin gh-pages
          else
            echo "No changes to gh-pages (library already present)."
          fi
          popd

      # ----------------------------
      # APPS
      # ----------------------------
      - uses: mikefarah/yq@v4.44.3

      - name: Add chart repos for dependencies
        if: steps.changes.outputs.charts != '' || steps.changes.outputs.lib_changed == 'true'
        run: |
          set -euo pipefail
          helm repo add bcit-ltc https://bcit-ltc.github.io/helm-charts || true
          helm repo update

      - name: Sync & build chart dependencies (apps)
        if: steps.changes.outputs.charts != '' || steps.changes.outputs.lib_changed == 'true'
        run: |
          set -euo pipefail
          for d in charts/*; do
            [[ -f "$d/Chart.yaml" ]] || continue
            [[ "$(basename "$d")" == "apps-common" ]] && continue
            echo "==> helm dependency update $d"
            helm dependency update "$d"
          done

      - name: Package app charts
        if: steps.changes.outputs.charts != '' || steps.changes.outputs.lib_changed == 'true'
        run: |
          set -euo pipefail
          mkdir -p .cr-release-packages

          IFS=',' read -ra CHANGED <<< "${{ steps.changes.outputs.charts }}"
          echo "CHANGED charts: ${CHANGED[*]:-(none)}"

          for d in charts/*; do
            [[ -f "$d/Chart.yaml" ]] || continue

            chart="$(basename "$d")"

            # Skip library here
            [[ "$chart" == "apps-common" ]] && continue

            # If we have a non-empty changed list, skip anything not in it
            if (( ${#CHANGED[@]} > 0 )); then
              skip=1
              for c in "${CHANGED[@]}"; do
                [[ "$c" == "$chart" ]] && skip=0 && break
              done
              if (( skip )); then
                echo "Skipping $chart (no changes)."
                continue
              fi
            fi

            echo "==> helm package $d -d .cr-release-packages"
            helm package "$d" -d .cr-release-packages
          done

          ls -la .cr-release-packages || true

      - name: Upload app packages to Releases
        if: steps.changes.outputs.charts != '' || steps.changes.outputs.lib_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cr upload \
            --owner "${GITHUB_REPOSITORY_OWNER}" \
            --git-repo "${GITHUB_REPOSITORY#*/}" \
            --skip-existing \
            --token "${GH_TOKEN}"

      # ----------------------------
      # gh-pages
      # ----------------------------
      - name: Update gh-pages (publish library + apps)
        if: steps.changes.outputs.charts != '' || steps.changes.outputs.lib_changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          REPO_URL: https://bcit-ltc.github.io/helm-charts
        run: |
          set -euo pipefail
          rm -rf .gh-pages
          git clone --depth 1 --branch gh-pages "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git" .gh-pages || (
            git init .gh-pages
            pushd .gh-pages
            git checkout -b gh-pages
            git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${REPO}.git"
            git commit --allow-empty -m "init gh-pages"
            git push -u origin gh-pages
            popd
          )

          mkdir -p .gh-pages
          cp -f .cr-release-packages/*.tgz .gh-pages/ || true

          if [[ -f .gh-pages/index.yaml ]]; then
            helm repo index .gh-pages --url "${REPO_URL}" --merge .gh-pages/index.yaml
          else
            helm repo index .gh-pages --url "${REPO_URL}"
          fi

          pushd .gh-pages
          git add -A
          if ! git diff --cached --quiet; then
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "index: update Helm chart repo"
            git push origin gh-pages
          else
            echo "No changes to gh-pages."
          fi
          popd

      # ----------------------------
      # PUBLISH TO GHCR (OCI) — only changed charts
      # ----------------------------
      - name: Login to GHCR (Helm)
        if: steps.changes.outputs.charts != ''
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            -u "${{ github.actor }}" --password-stdin

      - name: Login to GHCR (Cosign)
        if: steps.changes.outputs.charts != ''
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: sigstore/cosign-installer@v3
        if: steps.changes.outputs.charts != ''

      - uses: imjasonh/setup-crane@v0.4
        if: steps.changes.outputs.charts != ''
        with:
          version: v0.20.1

      - name: Push & sign charts to GHCR (only changed charts)
        if: steps.changes.outputs.charts != ''
        env:
          OWNER: ${{ github.repository_owner }}
          LIB_NAME: ${{ env.LIB_NAME }}
        run: |
          set -euo pipefail
          shopt -s nullglob

          repo="oci://ghcr.io/${OWNER}/oci"
          WORKFLOW_SAFE="$(printf '%s' "${GITHUB_WORKFLOW:-}" | tr -c '[:alnum:]._-' '_')"

          pkgs=(.cr-release-packages/*.tgz)
          if (( ${#pkgs[@]} == 0 )); then
            echo "No local packages to publish."
            exit 0
          fi

          IFS=',' read -ra CHANGED <<< "${{ steps.changes.outputs.charts }}"

          for pkg in "${pkgs[@]}"; do
            name="$(helm show chart "$pkg"   | awk -F': ' '/^name:/{print $2; exit}')"
            version="$(helm show chart "$pkg"| awk -F': ' '/^version:/{print $2; exit}')"

            # Skip publishing the library chart to OCI (optional)
            if [[ "$name" == "${LIB_NAME}" ]]; then
              echo "Skipping OCI publish for library chart: $name"
              continue
            fi

            # Skip charts that didn't change
            skip=1
            for c in "${CHANGED[@]}"; do
              [[ "$c" == "$name" ]] && skip=0 && break
            done
            if (( skip )); then
              echo "Skipping OCI publish for $name (no changes)."
              continue
            fi

            REF_BASE="ghcr.io/${OWNER}/oci/${name}"
            TAG_REF="${REF_BASE}:${version}"

            echo "==> Forcing push of ${TAG_REF} (overwriting any existing tag)"

            PUSH_OUT="$(helm push "$pkg" "${repo}" 2>&1 | tee /dev/stderr)"

            DGST="$(printf '%s\n' "$PUSH_OUT" | tr -d '\r' | awk 'tolower($1)=="digest:" {print $2; exit}')"
            [[ -n "$DGST" && "$DGST" =~ ^sha256:[0-9A-Fa-f]{64}$ ]] || { echo "Failed to parse digest"; exit 1; }

            echo "Signing ${REF_BASE}@${DGST} with Cosign (keyless)…"
            cosign sign --yes \
              -a "chart.name=${name}" \
              -a "chart.version=${version}" \
              -a "repo=${GITHUB_REPOSITORY}" \
              -a "workflow=${WORKFLOW_SAFE}" \
              -a "sha=${GITHUB_SHA}" \
              "${REF_BASE}@${DGST}"

            echo "Tagging 'latest' -> ${DGST}"
            crane tag "${REF_BASE}@${DGST}" latest
          done
