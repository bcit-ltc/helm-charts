{{- if and .Values.assets .Values.assets.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ printf "%s-populate-assets" (include "apps-common.app.name" .) | trunc 63 | trimSuffix "-" }}
  labels:
{{ include "apps-common.app.labels" . | nindent 4 }}
spec:
  template:
    metadata:
      labels:
{{ include "apps-common.app.labels" . | nindent 8 }}
    spec:
      restartPolicy: OnFailure
      {{- if .Values.assets.coLocateWithApp }}
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: {{ include "apps-common.app.name" . | quote }}
              topologyKey: kubernetes.io/hostname
      {{- end }}

      containers:
        - name: oras
          image: "{{ .Values.assets.image.repository }}:{{ .Values.assets.image.tag }}"
          imagePullPolicy: {{ .Values.assets.image.pullPolicy | default "IfNotPresent" }}
          env:
            - name: ORAS_REF
              value: {{ required "values.assets.ref is required" .Values.assets.ref | quote }}
            - name: GITHUB_USER
              value: {{ .Values.assets.githubUser | default "github" | quote }}
            - name: TOKEN_PATH
              value: {{ .Values.assets.tokenPath | default "/etc/secrets/GITHUB_TOKEN" | quote }}
          resources:
{{ toYaml .Values.assets.resources | nindent 12 }}
          command: ["/bin/sh","-ceu"]
          args:
            - |
              SRC=/workspace
              DEST=/multimedia-assets

              MARK="$DEST/.augmented.$(printf '%s' "$ORAS_REF" | tr '/:' '__')"
              mkdir -p "$DEST/.rsync-tmp"

              [ -f "$MARK" ] && { echo "[oras] Already augmented for $ORAS_REF"; exit 0; }

              # Login to ghcr.io
              HOST="$(printf '%s' "$ORAS_REF" | cut -d'/' -f1)"
              if [ -s "$TOKEN_PATH" ]; then
                oras login "$HOST" -u "$GITHUB_USER" -p "$(cat "$TOKEN_PATH")"
              fi

              echo "[oras] pulling ${ORAS_REF}"
              oras pull "$ORAS_REF"

              echo "[oras] extracting archive..."
              if [ -f "$SRC/assets.tgz" ]; then
                tar -xzvf "$SRC/assets.tgz"
                rm -f "$SRC/assets.tgz"
              fi

              echo "[augment] Copying asset files to PVC (add-only)"
              cp -rp --update "$SRC/." "$DEST/" || true

              COUNT=$(find "$DEST" -type f | wc -l || true)
              echo "[augment] Augmented $COUNT files into PVC: $COUNT"

              sync
              touch "$MARK"
          volumeMounts:
            - name: assets
              mountPath: /multimedia-assets
            - name: init-secrets
              mountPath: /etc/secrets
              readOnly: true
      volumes:
        - name: assets
          persistentVolumeClaim:
            claimName: {{ .Values.assets.pvcName | default "multimedia-assets" | quote }}
        - name: init-secrets
          projected:
            sources:
              - secret:
                  name: {{ .Values.assets.secretName | default "legacy-github-token" | quote }}
                  items:
                    - key: GITHUB_TOKEN
                      path: GITHUB_TOKEN
{{- end }}
