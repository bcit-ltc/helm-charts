# SPDX-License-Identifier: MPL-2.0

# Global configuration settings
global:
  # -- Authoritative name
  name: "legacy-soh-sonography"
  imagePullSecrets: []
  revisionHistoryLimit: 3
  progressDeadlineSeconds: 600
# -- Configuration for the service account
# @default -- `{}`
serviceAccount:
  # -- Enable or disable service account creation.
  create: true
  # -- Name of the service account to create. If empty uses global.name
  name: ""
  # Extra annotations to attach to the service account
  annotations: {}
# -- Enables a service for the app
# @default -- `{}`
service:
  # -- Enable or disable service components.
  enabled: true
  # -- Service type: by default, connect to the app using an internal cluster IP
  type: ClusterIP
  # -- Port on which the app is listening
  port: 8080
  # -- Target port to which the service should be mapped to
  targetPort: 8080
  # Extra annotations to attach to the service
  annotations: {}
# -- Security context for the pod template<br>
# @default -- 
#   &nbsp;&nbsp;`runAsNonRoot: true`<br>
#   &nbsp;&nbsp;`runAsGroup: 101`<br>
#   &nbsp;&nbsp;`runAsUser: 101`<br>
#   &nbsp;&nbsp;`fsGroup: 101`<br>
# - Set to `null` to disable
securityContext:
  pod: null
# -- Main "frontend" configuration
# @default -- `{}`
frontend:
  # -- Enable or disable frontend components.
  enabled: true
  # -- The name of the frontend container to create. If empty uses "frontend"
  name: legacy-soh-sonography
  image:
    # -- Frontend image default pull policy
    pullPolicy: IfNotPresent
    # -- Frontend image registry
    registry: "ghcr.io"
    # -- Frontend image repository
    repository: "bcit-ltc/legacy-soh-sonography"
    # -- Frontend image tag
    tag: "1.0.5-rc.20251029002205.2db79d7"
  # Extra annotations to attach to the frontend
  # @default -- `{}`
  annotations: {}
  # -- Add a checksum annotation to the server pods that is a hash
  #    of the configuration. Can be used to identify configuration changes.
  includeConfigAnnotation: false
  # -- Security context for the frontend container. Default:<br>
  # &nbsp;&nbsp;`readOnlyRootFilesystem: true`<br>
  # &nbsp;&nbsp;`allowPrivilegeEscalation: false`<br>
  # &nbsp;&nbsp;`capabilities:`<br>
  # &nbsp;&nbsp;&nbsp;&nbsp;`drop`:<br>
  # &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`- ALL`<br>
  # - Set to `null` to disable
  securityContext:
    container: null
  resources:
    # -- Resource requests mapped directly to the value of
    #    the resources field for a PodSpec.
    requests:
      memory: 64Mi
      cpu: 100m
    # -- Resource limits mapped directly to the value of
    #    the resources field for a PodSpec.
    limits:
      memory: 256Mi
      cpu: 250m
  # -- Port on which the frontend is listening
  port: 8080
  # -- List of extra environment variables that are set literally.
  # @default -- `[]`
  extraEnvVars: []
  # - API_URL: "https://app.example.com/api"
  # -- configEnvs create ConfigMaps that are passed to containers using envFrom
  # @default -- `[]`
  configEnvs: []
  # - name: "special-config"
  # -- volumeMounts for the frontend container that also create corresponding `emptyDir` volumes in the pod.
  # @default -- `[{name: tmp, mountPath: /tmp}]`
  emptyDirMounts:
    - name: tmp
      mountPath: /tmp
    # - name: seed-tmp
    #   mountPath: /seed
  # -- volumeMounts to be added as configMaps. Requires matching configs.
  # @default -- `[]`
  configMounts: []
  # - name: php-ini
  #   mountPath: /usr/local/etc/php/conf.d
  #   data:
  #     php.ini: |-
  #       upload_max_filesize=4G
  #       post_max_size=6G
  #       memory_limit=8G
  # -- Configuration for persistent volume claims
  # @default -- `[]`
  storageMounts:
  - name: multimedia-assets
    size: 5Gi
  # -- Location where the PVC will be mounted.
    mountPath: "/usr/share/nginx/html/multimedia"
  # -- Whether the volume should be mounted read-only.
    readOnly: true
  # -- Name of the storage class to use. If null it will use the
  # configured default Storage Class.
    storageClass: legacy-large-files
  # -- Access Mode of the storage device being used for the PVC
    accessMode: ReadWriteOnce
  secretMounts: []
  # -- volumeMounts to be added as secrets
  # # Credentials to access the app internal management portal (local account)
  # - name: github-token # volume name (must be DNS-1123 compliant)
  #   secretName: github-token # refers to existing Secret in the same namespace
  #   mountPath: /etc/secrets
  #   items: # optional: map specific keys to paths (and per-file mode)
  #     - key: GITHUB_TOKEN
  #       path: github-token/GITHUB_TOKEN
  # Defines custom livenessProbe settings
  livenessProbe:
    # -- Enables livenessProbe
    enabled: false
    # exec is preferred to httpGet (path) as the livenessProbe handler.
    execCommand: []
    # - /bin/sh
    # - -c
    # - <command>
    # Path for the httpGet handler
    path: "/"
    # Port number on which livenessProbe will be checked if httpGet is used as the livenessProbe handler
    port: 8080
    # When a probe fails, Kubernetes will try failureThreshold times before giving up
    failureThreshold: 2
    # Number of seconds after the container has started before probe initiates
    initialDelaySeconds: 10
    # How often (in seconds) to perform the probe
    periodSeconds: 5
    # Minimum consecutive successes for the probe to be considered successful after having failed
    successThreshold: 1
    # Number of seconds after which the probe times out.
    timeoutSeconds: 5
  # Defines custom readinessProbe settings
  readinessProbe:
    # -- Enables readinessProbe
    enabled: false
    # If you need to use a http path instead of the default exec
    # path: /health?standbyok=true
    # Port number on which readinessProbe will be checked.
    port: 8080
    # When a probe fails, Kubernetes will try failureThreshold times before giving up
    failureThreshold: 2
    # Number of seconds after the container has started before probe initiates
    initialDelaySeconds: 5
    # How often (in seconds) to perform the probe
    periodSeconds: 5
    # Minimum consecutive successes for the probe to be considered successful after having failed
    successThreshold: 1
    # Number of seconds after which the probe times out.
    timeoutSeconds: 5
  # Defines custom startupProbe settings
  startupProbe:
    # -- Enables startupProbe
    enabled: false
    # When a probe fails, Kubernetes will try failureThreshold times before giving up
    failureThreshold: 12
    # Number of seconds after the container has started before probe initiates
    initialDelaySeconds: 5
    # How often (in seconds) to perform the probe
    periodSeconds: 5
    # Minimum consecutive successes for the probe to be considered successful after having failed
    successThreshold: 1
    # Number of seconds after which the probe times out.
    timeoutSeconds: 5
# -- Add an initContainer configuration
# @default -- `{}`
initContainer:
  # -- Enable or disable initContainer components.
  enabled: true
  image:
    # -- initContainer image default pull policy
    pullPolicy: IfNotPresent
    # -- initContainer imageregistry
    registry: "ghcr.io"
    # -- initContainer image repository
    repository: "go-containerregistry/crane"
    # -- initContainer image tag
    tag: "debug"
  # command to run in the initContainer
  # @default -- `["/bin/sh"]`
  command: []
  # Arguments to pass to the initContainer command
  args: ["-ceu", "/usr/local/seed-pvc.sh"]
  securityContext:
    container:
      readOnlyRootFilesystem: false
      runAsUser: 0
      runAsGroup: 0
      runAsNonRoot: false
      capabilities:
        drop: ["ALL"]
  resources:
    # -- Resource requests mapped directly to the value of
    #    the resources field for a PodSpec.
    requests:
      memory: 128Mi
      cpu: 100m
    # -- Resource limits mapped directly to the value of
    #    the resources field for a PodSpec.
    limits:
      memory: 512Mi
      cpu: 500m
  # -- List of extra environment variables that are set literally.
  # @default -- `[]`
  extraEnvVars:
    - APP_IMAGE: "ghcr.io/bcit-ltc/legacy-soh-sonography:1.0.5-rc.20251029002205.2db79d7"
    - TOKEN_PATH: "/etc/secrets/GITHUB_TOKEN"
    # Optional; oras login needs some username string when a token is present.
    - GITHUB_USER: "github"

  # - API_URL: "https://app.example.com/api"
  # -- Create `ConfigMap` resources that are passed to containers using envFrom
  # @default -- `[]`
  configEnvs: []
  # - name: "special-config"
  # -- volumeMounts for the initContainer that also create corresponding emptyDir volumes in the pod.
  # @default -- `[]`
  emptyDirMounts:
    - name: seed-tmp
      mountPath: /seed
    - name: multimedia-assets
      mountPath: /dest
  # -- volumeMounts to be added as configMaps. Requires matching configs.
  # @default -- `[]`
  configMounts:
    - name: seed-pvc
      mountPath: /usr/local
      defaultMode: 0755
      data:
        seed-pvc.sh: |
          #!/bin/sh
          set -ceu
          DEST=/dest
          SEED=/seed
          GITHUB_USER="${GITHUB_USER:-github}"
          TOKEN_PATH="${TOKEN_PATH:-/etc/secrets/GITHUB_TOKEN}"
          : "${APP_IMAGE:?APP_IMAGE (app image ref) is required}"

          mkdir -p "$DEST" "$SEED"

          HOST="$(printf '%s' "$APP_IMAGE" | cut -d'/' -f1)"
          if [ -s "$TOKEN_PATH" ]; then
            crane auth login "$HOST" -u "$GITHUB_USER" -p "$(cat "$TOKEN_PATH")"
          fi

          echo "[seed] Exporting $APP_IMAGE filesystem..."
          crane export "$APP_IMAGE" - | tar -x -C "$SEED"

          SRC="$SEED/usr/share/nginx/html/multimedia"
          if [ ! -d "$SRC" ]; then
            echo "[seed] ERROR: $SRC not found in image" >&2
            exit 1
          fi

          echo "[seed] Copying baked-in files to PVC (add-only)"
          if command -v rsync >/dev/null 2>&1; then
            rsync -a --ignore-existing "$SRC/" "$DEST/"
          else
            # Fallback: cp -a -n (no clobber). BusyBox/GNU cp usually supports -n.
            # Preserve attrs (-a) and avoid overwriting existing files (-n).
            cp -a -n "$SRC/." "$DEST/" || true
          fi

          COUNT=$(find "$DEST" -type f | wc -l || true)
          echo "[seed] Seeded $COUNT files into PVC: $COUNT"

  # -- volumeMounts to be added as secrets
  # @default -- `[]`
  secretMounts:
    # Credentials to access the app internal management portal (local account)
    - name: init-secrets # volume name (must be DNS-1123 compliant)
      secretName: legacy-github-token # refers to existing Secret in the same namespace
      mountPath: /etc/secrets
      items: # optional: map specific keys to paths (and per-file mode)
        - key: GITHUB_TOKEN
          path: GITHUB_TOKEN
# -- Main "backend" configuration
# @default -- `{}`
processor:
  # -- Enable or disable processor components.
  enabled: false
  image:
    # -- Processor image default pull policy
    pullPolicy: IfNotPresent
    # -- Processor imageregistry
    registry: "ghcr.io"
    # -- Processor image repository
    repository: ""
    # -- Processor image tag
    tag: ""
  # -- Number of replicas for the processor
  replicas: 1
  # -- Port on which processor is listening
  port: 8000
  # -- List of extra environment variables that are set literally.
  # @default -- `[]`
  extraEnvVars: []
  # - API_URL: "https://app.example.com/api"
  # Extra annotations to attach to the processor container
  # @default -- `{}`
  annotations: {}
  # -- Create `ConfigMap` resources that are passed to containers using envFrom
  # @default -- `[]`
  configEnvs: []
  # - name: "special-config"
  # -- volumeMounts for the processor container that also create corresponding emptyDir volumes in the pod.
  # @default -- `[]`
  emptyDirMounts: []
  # - name: shared-data
  #   mountPath: /var/www/html
  # -- Security context for the processor container. Default:<br>
  # &nbsp;&nbsp;`readOnlyRootFilesystem: true`<br>
  # &nbsp;&nbsp;`allowPrivilegeEscalation: false`<br>
  # &nbsp;&nbsp;`capabilities:`<br>
  # &nbsp;&nbsp;&nbsp;&nbsp;`drop`:<br>
  # &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`- ALL`<br>
  # - Set to `null` to disable
  securityContext:
    container: null
  # -- volumeMounts to be added as configMaps. Requires matching configs.
  # @default -- `[]`
  configMounts: []
  # - name: php-ini
  #   mountPath: /usr/local/etc/php/conf.d
  #   data:
  #     php.ini: |-
  #       upload_max_filesize=4G
  #       post_max_size=6G
  #       memory_limit=8G
  # Configuration for persistent volume claims
  # @default -- `[]`
  storageMounts: []
  # - name: data-storage
  #   size: 10Gi
  # # -- Location where the PVC will be mounted.
  #   mountPath: "/app/data"
  # # -- Name of the storage class to use. If null it will use the
  # # configured default Storage Class.
  #   storageClass: null
  # # -- Access Mode of the storage device being used for the PVC
  #   accessMode: ReadWriteOnce
  # -- volumeMounts to be added as secrets
  # @default -- `[]`
  secretMounts: []
  # # Credentials to access the app internal management portal (local account)
  # - name: app-internal-credentials # volume name (must be DNS-1123 compliant)
  #   secretName: app-internal-credentials # refers to existing Secret in the same namespace
  #   mountPath: /etc/secrets
  #   items: # optional: map specific keys to paths (and per-file mode)
  #     - key: ADMIN_USERNAME
  #       path: app-internal-credentials/ADMIN_USERNAME
assets:
  enabled: true
  # 👇 the only thing you change per rollout/project
  ref: "ghcr.io/bcit-ltc/legacy-soh-sonography-assets:2025-10-26"

  # sensible defaults you can leave alone
  pvcName: "multimedia-assets"
  secretName: "legacy-github-token"
  githubUser: "github"
  tokenPath: "/etc/secrets/GITHUB_TOKEN"
  image:
    repository: "ghcr.io/oras-project/oras"
    tag: "v1.2.0"
    pullPolicy: IfNotPresent
  coLocateWithApp: true
  resources:
    requests: { cpu: "100m", memory: "128Mi" }
    limits:   { cpu: "500m", memory: "512Mi" }

# -- Creates an ingress for external access
# @default -- `{}`
ingress:
  enabled: false
  # -- Default domain for the ingress
  # @default -- `""`
  defaultDomain: ""
  # Optional: "nginx", "traefik", etc. If empty, cluster default is used.
  ingressClassName: ""
  # Host to expose. If empty, defaults to "<global.name>.<defaultDomain>"
  host: ""
  # Annotations applied to the Ingress
  annotations: {}
  # -- TLS secret to use.
  # Sets `<spec.tls.hosts>` to `<global.name>.<defaultDomain>`
  # @default -- `""`
  tlsSecret: ""
  # -- Extra path rules to render verbatim before the default "/".
  extraPaths: []
  #   - path: /api
  #     pathType: Prefix
  #     backend:
  #       service:
  #         name: my-api
  #         port:
  #           number: 3000
  # -- Path type for the default route ("/")
  pathType: Prefix
# Unconfigured options
# autoscaling:
#   enabled: false
#   minReplicas: 2
#   maxReplicas: 5
#   targetCPUUtilizationPercentage: 80
# pdb:
#   enabled: false
#   minAvailable: 1
# networkPolicy:
#   enabled: false
